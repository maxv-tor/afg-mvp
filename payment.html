<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Complete Your Application - Payment Required</title>
  <meta name="color-scheme" content="light">
  <style>
    :root{
      --primary:#2EA3F2;
      --primary-600:#1f83c5;
      --primary-100:#e8f5ff;
      --secondary:#A7144C;
      --text:#333333;
      --text-muted:#666666;
      --bg:#ffffff;
      --card:#ffffff;
      --border:#bbbbbb;
      --border-soft:#eeeeee;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --radius:12px;
      --radius-sm:10px;
      --danger:#d92d20;
      --success:#16a34a;
      --warning:#f59e0b;
      --focus: var(--primary);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 "Open Sans",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif}
    .container{max-width:680px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--border-soft);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    header{padding:24px 32px;border-bottom:1px solid var(--border-soft);text-align:center}
    header h1{margin:0 0 8px;font-size:24px;font-weight:700;color:var(--primary)}
    header p{margin:0;color:var(--text-muted);font-size:16px}
    .content{padding:32px}
    .banner{
      padding:16px 20px;border-left:4px solid var(--warning);background:#fef3c7;border-radius:8px;margin-bottom:24px;color:#92400e
    }
    .banner.info{border-left-color:var(--primary);background:var(--primary-100);color:#1e40af}
    .price-box{
      background:#f8fafc;border:2px solid var(--border-soft);border-radius:var(--radius);
      padding:24px;text-align:center;margin:24px 0
    }
    .price{font-size:48px;font-weight:700;color:var(--primary);margin:0}
    .price-desc{color:var(--text-muted);margin:8px 0 0;font-size:14px}
    .features{
      list-style:none;padding:0;margin:16px 0;text-align:left
    }
    .features li{
      padding:8px 0;position:relative;padding-left:24px
    }
    .features li:before{
      content:'âœ“';color:var(--success);font-weight:bold;position:absolute;left:0
    }
    .btn{
      appearance:none;border:2px solid var(--primary);background:var(--primary);color:#fff;
      padding:14px 28px;border-radius:8px;font-weight:600;cursor:pointer;transition:all .2s;
      font-size:16px;width:100%;margin:16px 0
    }
    .btn:hover{background:var(--primary-600)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.secondary{border-color:var(--border);background:transparent;color:var(--text)}
    .btn.secondary:hover{background:#f9fafb}
    .error{
      padding:12px 16px;background:#fef2f2;border:1px solid #fecaca;color:var(--danger);
      border-radius:var(--radius-sm);margin:16px 0;display:none
    }
    .error.show{display:block}
    .loading{
      display:none;align-items:center;justify-content:center;gap:12px;
      padding:16px;color:var(--text-muted)
    }
    .loading.show{display:flex}
    .spinner{
      width:20px;height:20px;border:2px solid var(--border-soft);
      border-top:2px solid var(--primary);border-radius:50%;
      animation:spin 1s linear infinite
    }
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .form-group{margin:16px 0}
    .form-group label{display:block;font-weight:600;margin-bottom:8px}
    .form-group input{
      width:100%;padding:12px;border:1px solid var(--border);border-radius:var(--radius-sm);
      background:#fff;color:var(--text);outline:none;transition:border-color .2s
    }
    .form-group input:focus{border-color:var(--focus);box-shadow:0 0 0 3px var(--primary-100)}
    .summary{
      background:#f8fafc;padding:16px;border-radius:var(--radius-sm);margin:16px 0;
      border-left:4px solid var(--primary)
    }
    .summary h3{margin:0 0 8px;font-size:16px}
    .summary p{margin:4px 0;color:var(--text-muted);font-size:14px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <h1>Complete Your Application</h1>
        <p>A small processing fee is required to proceed with your funding application review</p>
      </header>
      
      <div class="content">
        <div class="banner info">
          <strong>Secure Payment:</strong> Your payment is processed securely through Stripe. We never store your payment information.
        </div>

        <div class="summary" id="applicationSummary" style="display:none">
          <h3>Application Summary</h3>
          <p><strong>Applicant:</strong> <span id="summaryName">-</span></p>
          <p><strong>Email:</strong> <span id="summaryEmail">-</span></p>
          <p><strong>Submission ID:</strong> <span id="summarySubmissionId">-</span></p>
        </div>

        <div class="price-box">
          <div class="price">CHF 2000</div>
          <div class="price-desc">One-time application processing fee</div>
          
          <ul class="features">
            <li>Complete application review by our team</li>
            <li>Matching with relevant lenders</li>
            <li>Priority processing (48-72 hours)</li>
            <li>Direct communication with matched lenders</li>
            <li>No hidden fees or ongoing charges</li>
          </ul>
        </div>

        <!-- Manual Entry Form (if no URL parameters) -->
        <div id="manualEntryForm">
          <h3>Enter Your Information</h3>
          <div class="form-group">
            <label for="submissionId">Submission ID</label>
            <input type="text" id="submissionId" placeholder="Enter your submission ID" />
          </div>
          <div class="form-group">
            <label for="clientEmail">Email Address</label>
            <input type="email" id="clientEmail" placeholder="Enter your email" />
          </div>
          <div class="form-group">
            <label for="fullName">Full Name</label>
            <input type="text" id="fullName" placeholder="Enter your full name" />
          </div>
        </div>

        <div class="error" id="errorMessage"></div>
        
        <div class="loading" id="loadingSpinner">
          <div class="spinner"></div>
          <span>Creating secure payment session...</span>
        </div>

        <button type="button" class="btn" id="proceedToPaymentBtn">
          Proceed to Secure Payment
        </button>

        <button type="button" class="btn secondary" onclick="window.history.back()">
          Go Back
        </button>

        <div style="margin-top:24px;padding:16px;background:#f9fafb;border-radius:8px;font-size:14px;color:var(--text-muted);text-align:center">
          <p><strong>Questions?</strong> Contact our support team for assistance with your application.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const errorEl = document.getElementById('errorMessage');
      const loadingEl = document.getElementById('loadingSpinner');
      const proceedBtn = document.getElementById('proceedToPaymentBtn');
      const manualForm = document.getElementById('manualEntryForm');
      const summaryEl = document.getElementById('applicationSummary');
      
      let submissionId = '';
      let clientEmail = '';
      let fullName = '';

      function showError(message) {
        errorEl.textContent = message;
        errorEl.classList.add('show');
        setTimeout(() => errorEl.classList.remove('show'), 8000);
      }

      function hideError() {
        errorEl.classList.remove('show');
      }

      function showLoading(show = true) {
        loadingEl.classList.toggle('show', show);
        proceedBtn.disabled = show;
      }

      function updateSummary() {
        if (submissionId && clientEmail && fullName) {
          document.getElementById('summarySubmissionId').textContent = submissionId;
          document.getElementById('summaryEmail').textContent = clientEmail;
          document.getElementById('summaryName').textContent = fullName;
          summaryEl.style.display = 'block';
          manualForm.style.display = 'none';
        } else {
          summaryEl.style.display = 'none';
          manualForm.style.display = 'block';
        }
      }

      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          submission_id: params.get('submission_id') || '',
          client_email: params.get('client_email') || params.get('email') || '',
          full_name: params.get('full_name') || params.get('name') || ''
        };
      }

      function validateInputs() {
        const sid = submissionId || document.getElementById('submissionId').value.trim();
        const email = clientEmail || document.getElementById('clientEmail').value.trim();
        const name = fullName || document.getElementById('fullName').value.trim();

        if (!sid) {
          showError('Submission ID is required');
          return false;
        }
        if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
          showError('Valid email address is required');
          return false;
        }
        if (!name) {
          showError('Full name is required');
          return false;
        }

        // Update global vars
        submissionId = sid;
        clientEmail = email;
        fullName = name;
        return true;
      }

      async function createPaymentSession() {
        if (!validateInputs()) return;

        hideError();
        showLoading(true);

        try {
          const response = await fetch('https://contentlabs.app.n8n.cloud/webhook/create-payment-session', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              submission_id: submissionId,
              client_email: clientEmail,
              full_name: fullName
            })
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || `HTTP ${response.status}`);
          }

          if (result.success && result.checkout_url) {
            // Redirect to Stripe Checkout
            window.location.href = result.checkout_url;
          } else {
            throw new Error(result.error || 'Failed to create payment session');
          }

        } catch (error) {
          console.error('Payment session error:', error);
          showError(error.message || 'Failed to create payment session. Please try again.');
        } finally {
          showLoading(false);
        }
      }

      // Initialize
      function init() {
        const urlParams = getUrlParams();
        submissionId = urlParams.submission_id;
        clientEmail = urlParams.client_email;
        fullName = urlParams.full_name;

        updateSummary();

        // Pre-fill manual form if partially available
        if (submissionId) document.getElementById('submissionId').value = submissionId;
        if (clientEmail) document.getElementById('clientEmail').value = clientEmail;
        if (fullName) document.getElementById('fullName').value = fullName;
      }

      // Event listeners
      proceedBtn.addEventListener('click', createPaymentSession);

      // Update summary when manual inputs change
      ['submissionId', 'clientEmail', 'fullName'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
          // Update globals from form
          submissionId = document.getElementById('submissionId').value.trim();
          clientEmail = document.getElementById('clientEmail').value.trim();
          fullName = document.getElementById('fullName').value.trim();
          updateSummary();
        });
      });

      // Initialize the page
      init();
    })();
  </script>
</body>
</html>
